# `nmap`

## Deploy (Box Info)

-   IP: `10.10.186.105`

## Intro

-   In hacking/pentesting, getting a feel for the box you're looking to attack is important. One of the first steps should be seeing what ports are open
-   Ports are ways to open up applications on a server for network requests
-   Connections: (server) static open port [80, 443, etc.] <-> random port [usually high numbered] (client)
-   Every machine has 65535 open ports. Many are registered as standards [i.e. 80: http; 25565: Minecraft]
    -   In a hacking/pentesting situation, these ports may be changed. Scanning helps determine this
-   `nmap` is an industry standard tool for scanning ports, and should be the first go-to for attacking a box
    -   It connects to each port in turn
    -   Port can either be open, closed, or filtered (usually via a firewall)
    -   Can use info to enumerate all ports (also using `nmap`)
    -   `nmap` has a powerful scripting engine that can scan for vulnerabilities, and sometimes perform exploits

### Questions

1. What networking constructs are used to direct traffic to the right application on a server? [*Ports*]
2. How many of these are available on any network-enabled computer? [*65535*]
3. [Research] How many of these are considered "well-known"? (These are the "standard" numbers mentioned in the task) [*1024*]
    - Google search: `how many standard ports are there`
    - Found: [List of ports from Wikipedia: Well-known ports](https://en.wikipedia.org/wiki/List_of_TCP_and_UDP_port_numbers#Well-known_ports)

## `nmap` switches

-   `nmap` is available in Linux and Windows both
-   The man page and the help command (`nmap -h`) are very verbose, has a bunch of info

### Questions

All of these were answered using `man nmap` and `nmap -h`.

1. What is the first switch listed in the help menu for a 'Syn Scan' (more on this later!)? [`-sS`]
2. Which switch would you use for a "UDP scan"? [`-sU`]
3. If you wanted to detect which operating system the target is running on, which switch would you use? [`-O`]
4. Nmap provides a switch to detect the version of the services running on the target. What is this switch? [`-sV`]
5. The default output provided by nmap often does not provide enough information for a pentester. How would you increase the verbosity? [`-v`]
6. Verbosity level one is good, but verbosity level two is better! How would you set the verbosity level to two? [`-vv`]
7. We should always save the output of our scans -- this means that we only need to run the scan once (reducing network traffic and thus chance of detection), and gives us a reference to use when writing reports for clients. What switch would you use to save the nmap results in three major formats? [`-oA`]
8. What switch would you use to save the nmap results in a "normal" format? [`-oN`]
9. A very useful output format: how would you save results in a "grepable" format? [`-oG`]
10. Sometimes the results we're getting just aren't enough. If we don't care about how loud we are, we can enable "aggressive" mode. This is a shorthand switch that activates service detection, operating system detection, a traceroute and common script scanning. How would you activate this setting? [`-A`]
11. Nmap offers five levels of "timing" template. These are essentially used to increase the speed your scan runs at. Be careful though: higher speeds are noisier, and can incur errors! How would you set the timing template to level 5? [`-T5`]
12. We can also choose which port(s) to scan. How would you tell nmap to only scan port 80? [`-p 80`]
13. How would you tell nmap to scan ports 1000-1500? [`-p 1000-1500`]
14. A very useful option that should not be ignored: How would you tell nmap to scan all ports? [`-p-`]
    - Google search: `nmap scan all ports`
    - Found: [nmap cheat sheet](https://hackertarget.com/nmap-cheatsheet-a-quick-reference-guide/)
    - Makes sense. `-p` would specify a port scan and the second `-` would be part of the range, I think...
15. How would you activate a script from the nmap scripting library (lots more on this later!)? [`--script`]
16. How would you activate all of the scripts in the "vuln" category? [`--script=vuln`]

## Scan Types

### Overview

-   Three basic scan types
    -   TCP Connect Scans: `-sT`
    -   SYN Half-Open Scans: `-sS`
    -   UDP Scans: `-sU`
-   Three 'less known but still could be useful' scans
    -   TCP Null Scans: `-sN`
    -   TCP FIN Scans: `-sF`
    -   TCP Xmas Scans: `-sX`
-   These all mostly do the same thing but in different ways. One might be a go to (and probably work) but others may be more useful depending on the situation
-   Also covered: ICMP/'ping' scanning

### TCP Connect Scans: `-sT`

-   Uses the 3-way handshake from before (SYN, SYN/ACK, ACK) to determine open ports. Open ports will complete the handshake
-   If a port is closed, then the target box will send a RST (reset) flag once it receives the first SYN from the client box
    -   This is part of Internet Standard [RFC 793](https://tools.ietf.org/html/rfc793)
-   Filtered/firewall-blocked ports (when not configured to send a RST) will simply not respond

#### Questions

1. Which RFC defines the appropriate behavior for the TCP protocol? [*RFC 793*]
2. If a port is closed, which flag should the server send back to indicate this? [*RST*]

### SYN Scans: `-sS`

-   Also known as 'stealth scans'
-   These are very similar to TCP Connect Scans, but work differently
-   After the target box sends back a SYN/ACK, the client box sends back a RST instead of an ACK
-   This has several benefits
    -   Can be used to bypass older intrusion detection systems, which usually look for the full three way handshake
        -   Modern systems can check for these too though
    -   These scans usually are not logged by apps listening on open ports
        -   Standard practice is to only log when a connection has been fully established
    -   Since the handshake doesn't have to fully finish, SYN scans tend to be faster
-   There are some disadvantages
    -   You must run `nmap` with `sudo` for them to work correctly since raw packets have to be made, which only root has the ability to do by default
        -   SYN scans can also be made to work by giving Nmap the CAP_NET_RAW, CAP_NET_ADMIN and CAP_NET_BIND_SERVICE capabilities; however, this may not allow many of the NSE scripts to run properly.
    -   Any systems that are unstable might crash with these types of scans, which can be bad in a pentesting scenario
-   Same rules from the TCP Connect Scan apply to closed and filtered ports

#### Questions

1. There are two other names for a SYN scan, what are they? [*half-open, stealth*]
2. Can Nmap use a SYN scan without Sudo permissions? [*No*]

### UDP Scans: `-sU`

-   Different than TCP scans. UDP scans are stateless
    -   UDP depends on hopes and dreams. It just yeets it to the port and hopes for the best
-   UDP in general is good for speed, but is slow for scans since there's no acknowledgment
-   Packets sent are usually empty, unless it's a well-known port, in which it may include info that would elicit a response from a service that would normally use that port
-   When a packet is sent to a port with UDP, it may get:
    -   No response, which would mean it's either open or filtered (`open|filtered`) [most common case]
    -   A response (which is rare), which would mean it's open
    -   an ICMP/ping packet with a message, which would mean that it's closed
-   Since it's more difficult, UDP scans are very slow when scanning all ports. Usually recommended to scan the top-N ports when using UDP scans: `nmap -sU --top-ports N <target>`

#### Questions

1. If a UDP port doesn't respond to an Nmap scan, what will it be marked as? [`open|filtered`]
2. When a UDP port is closed, by convention the target should send back a "port unreachable" message. Which protocol would it use to do so? [*icmp*]

### NULL, FIN, and Xmas

-   Less commonly used
-   They tend to be stealthier than SYN scans
-   NULL Scans (`-sN`) are TCP scans with no flags set. If it's closed, it'll respond with RST
-   FIN Scans (`sF`) are TCP scans with the FIN flag set. Same result for closed, it'll send back a RST
-   Xmas Scans (`-sX`) are TCP scans that are malformed. Same again for closed, RST.
    -   It's called an Xmas scan because in Wireshark, the flags set (PSH, URG, FIN) make it look like a blinking Christmas tree
-   Expected response for all 3 with open ports are identical and similar to a UDP scan (no response)
-   Unfortunately, filtered is expected with the same thing, so in `nmap`, these 3 scans will never have just an `open` status, only `open|filtered`, `filtered`, or `closed`. Some filtered may respond with an ICMP unreachable packet
-   [RFC 793](https://tools.ietf.org/html/rfc793) mandates that closed ports respond with RST and open ports don't respond to malformed packets, but not everyone does it that way
    -   Windows and a bunch of Cisco networking devices will usually respond with a RST to any malformed packet
-   The goal of these scans is to avoid firewalls (modern systems sometimes catch these kind, but not all of them)

#### Questions

1. Which of the three shown scan types uses the URG flag? [*Xmas*]
2. Why are NULL, FIN and Xmas scans generally used? [*firewall evasion*]
3. Which common OS may respond to a NULL, FIN or Xmas scan with a RST for every port? [*Microsoft Windows*]

### ICMP Network Scanning `-sn`

-   First step to connect to a target network in a black-box situation is to map out what's open in the network. Want to see which IPs have active hosts and which one's do not
-   One method to see thing: a ping sweep
    -   `nmap` sends out an ICMP packet to each possible IP on a network. If it responds, it's marked as 'alive'
        -   Not always accurate but it can provide a baseline
-   Can either use a range or the CIDR notation (either `192.168.0.1-254` or `192.168.0.0/24`)
-   Does not scan any ports, relies on ICMP echo packets (or ARP request if ran with root/`sudo`)
-   Also sends TCP SYN packets to port 443 and TCP ACK (or also TCP SYN if not ran with `sudo`) to port 80 of the target

#### Questions

1. How would you perform a ping sweep on the 172.16.x.x network (Netmask: 255.255.0.0) using Nmap? (CIDR notation) [`nmap -sn 172.16.0.0/16`]
    - 16 is due to the Netmask being Class B. Might have to mark Netmask as another topic to look at, didn't see it in the intro to networking room

## NSE Scripts: `--script`

### Overview

-   The Nmap Scripting Engine (NSE) uses Lua in order to extend `nmap`
-   Usually used for scanning vulnerabilities and sometimes automating exploits for them
-   Good for reconnaissance, but the script library is very extensive with many categories
    -   `safe`: doesn't affect the target box
    -   `intrusive`: will most likely affect the target box
    -   `vuln`: scans for vulnerabilities
    -   `exploit`: tries to exploit vulnerabilities
    -   `auth`: tries to bypass auth for certain running services
    -   `brute`: tries to bruteforce credentials for running services
    -   `discovery`: attempts to query running services for extra info about the network
    -   [More categories and script here](https://nmap.org/book/nse-usage.html)

#### Questions

1. What language are NSE scripts written in? [*Lua*]
2. Which category of scripts would be a very bad idea to run in a production environment? [`intrusive`]

### Working with the NSE

-   Scripts are ran using `--script=<name>`. Either one or a list is given
-   `--script-args` will take arguments for certain scripts that need them.
    -   (i.e. `nmap -p 80 --script http-put --script-args http-put.url='/dav/shell.php',http-put.file='./shell.php'`)
    -   Separated by commas, formatted as `<script-name>.<arg>=<value>`
-   [Full list of included nmap scripts](https://nmap.org/nsedoc/)
-   Can find more info about scripts using `nmap --script-help <script-name>`

#### Questions

Using `nmap --script-help ftp-anon.nse`

1. What optional argument can the `ftp-anon.nse` script take? [`maxlist`]
    - Found [here](https://nmap.org/nsedoc/scripts/ftp-anon.html) from help command

### Searching for Scripts

-   To find scripts, you should both go to the [full list of included nmap scripts](https://nmap.org/nsedoc/) on the web and check the `/usr/share/nmap/scripts` directory where all the `nmap` scripts are stored
-   To search for installed scripts, check the `/usr/share/nmap/scripts/script.db` file (flat text file) or just `ls` the directory
-   Missing or new scripts can be either installed with a fresh `nmap` install (`sudo apt update && sudo apt install nmap`) or by downloading it directly (`sudo wget -O /usr/share/nmap/scripts/<script-name>.nse https://svn.nmap.org/nmap/scripts/<script-name>.nse`) and updating the `script.db` file (`nmap --script-updatedb`)

#### Questions

1. Search for "smb" scripts in the `/usr/share/nmap/scripts/` directory using either of the demonstrated methods. What is the filename of the script which determines the underlying OS of the SMB server? [`smb-os-discovery.nse`]
    - Used `grep 'smb' /usr/share/nmap/scripts/script.db`
2. Read through this script. What does it depend on? [`smb-brute`]
    - Look for the `dependencies` list

## Firewall Evasion

-   Windows by default will block all ICMP packets, which makes is hard since `ping` depends on ICMP
-   `-Pn` will avoid pinging a target box, forcing `nmap` to presume the target is alive
-   Can take longer, but will avoid the firewall block due to the ping
-   On a local network, `nmap` can also use ARP to determine activity
-   Other switches that can be useful (more info found [here](https://nmap.org/book/man-bypass-firewalls-ids.html))
    -   `-f` will fragment packets, which makes it harder for a firewall to detect them
    -   `--mtu N` does the same, but allows you to control the size (N must be a multiple of 8)
    -   `--scan-delay Nms` adds a N ms delay between packets sent, which is good for unstable systems and avoiding any time-based firewall triggers
    -   `--badsum` will generate an invalid checksum for packets. TCP/IP usually drops this, but a firewall may respond automatically, which would show if a network has a firewall or not (Immediate bad response would mean firewall, a hanging response would mean no firewall [or at least no rule for that])

### Questions

1. Which simple (and frequently relied upon) protocol is often blocked, requiring the use of the `-Pn` switch? [*ICMP*]
2. [Research] Which Nmap switch allows you to append an arbitrary length of random data to the end of packets? [`--data-length`]
    - Used `nmap -g | grep length`

## Practical

### Commands Ran

Files can be found in the `nmap/nmap_room` folder

0. `export THM_IP=10.10.186.105`
1. `ping $THM_IP`
2. `sudo nmap -p 0-999 -sX -Pn -oN nmap_room_2 $THM_IP`
3. `sudo nmap -p 0-999 -sX -Pn -vv -oN nmap/nmap_room/nmap_room_3 $THM_IP`
4. `sudo nmap -p 0-5000 -sS -Pn -vv -oN nmap/nmap_room/nmap_room_4 $THM_IP`
5. `nmap -sT -p 80 -vv $THM_IP`
6. `nmap -p 21 --script ftp-anon -oN nmap/nmap_room/nmap_room_6 $THM_IP`

### Questions

1. Does the target respond to ICMP (ping) requests? [*No*]
2. Perform an Xmas scan on the first 999 ports of the target -- how many ports are shown to be open or filtered? [`1000`]
3. There is a reason given for this -- what is it? Note: The answer will be in your scan results. [`no responses`]
4. Perform a TCP SYN scan on the first 5000 ports of the target -- how many ports are shown to be open? [`5`]
5. Open Wireshark and perform a TCP Connect scan against port 80 on the target, monitoring the results. Make sure you understand what's going on.
    - See writeup in the Extra Resources section
6. Deploy the ftp-anon script against the box. Can Nmap login successfully to the FTP server on port 21? [*Yes*]

## Extra Resources

-   [nmap docs](http://www.amazon.com/dp/0979958717?tag=secbks-20)
    -   I'll probably never buy it, but if it's for the right price at a Half Price Books? Bitch, I might...
-   [wireshark room writeup](https://scriptkiddiehub.com/2021/03/06/tryhackme-wireshark-101-writeup/)
    -   Why they would make you pay for a room linked to a free room is beyond me. I found a writeup for it, gonna have to probably find some other free tutorial as well...
    -   They deserve to be paid, but for a 101 lesson that's dependent on answering a question in a free room? No, absolutely not
